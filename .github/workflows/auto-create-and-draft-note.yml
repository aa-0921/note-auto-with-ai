# このワークフローは push, 手動実行, そしてcronスケジュールで autoCreateAndDraftNote.js を自動実行します
# cronスケジュールは auto-publish-notes.yml と同じ（JST 11:45, 17:45, 23:45）

name: Auto Create And Draft Note

on:
  schedule:
    # JST 6:00〜24:00の間で1日8回実行（2時間15分間隔）
    - cron: '0 21 * * *'   # JST 06:00
    - cron: '15 23 * * *'  # JST 08:15
    - cron: '30 1 * * *'   # JST 10:30
    - cron: '45 3 * * *'   # JST 12:45
    - cron: '0 6 * * *'    # JST 15:00
    - cron: '15 8 * * *'   # JST 17:15
    - cron: '30 10 * * *'  # JST 19:30
    - cron: '45 12 * * *'  # JST 21:45
    - cron: '0 15 * * *'   # JST 24:00 (翌日00:00)
  workflow_dispatch: # 手動実行

jobs:
  run-auto-create-and-draft-note:
    runs-on: ubuntu-latest
    steps:
      # 1. リポジトリのコードをチェックアウト
      - name: コードをチェックアウト
        uses: actions/checkout@v4

      # 2. note-auto-coreリポジトリをチェックアウト
      - name: note-auto-coreをチェックアウト
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: note-auto-core
          ref: main
          token: ${{ secrets.CORE_REPO_TOKEN }}

      # 2. Node.jsのセットアップ（バージョンは必要に応じて変更）
      - name: Node.jsをセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # 3. 依存パッケージのインストール
      - name: 依存パッケージをインストール
        run: |
          # note-auto-coreの依存関係をインストール
          cd note-auto-core && npm install
          cd ..
          # ローカルパッケージを直接参照してインストール
          npm install ./note-auto-core

      # 4. 必要な環境変数を設定（OpenRouter APIキーなど）
      #    GitHubリポジトリのSettings > Secrets and variables > Actions で設定してください
      - name: 環境変数を設定
        run: |
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV
          echo "NOTE_EMAIL=${{ secrets.NOTE_EMAIL }}" >> $GITHUB_ENV
          echo "NOTE_PASSWORD=${{ secrets.NOTE_PASSWORD }}" >> $GITHUB_ENV

      # 5. スクリプトを実行
      - name: autoCreateAndDraftNote.js を実行
        run: node scripts/autoCreateAndDraftNote.js
