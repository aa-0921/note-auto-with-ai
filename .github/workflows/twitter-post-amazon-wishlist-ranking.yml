name: Twitter Post Amazon Wishlist Ranking

on:
  schedule:
    - cron: '0 3,9,15,21 * * *'  # 3時、9時、15時、21時（UTC）、6時間おきに4回実行、交互実行
  workflow_dispatch:
    inputs:
      dryrun:
        description: 'Dryrun (true の場合は投稿しない)'
        required: false
        default: 'false'

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: twitter-post-amazon-wishlist-ranking
      cancel-in-progress: false
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Chrome dependencies for Puppeteer
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libasound2t64 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libxshmfence1

      - name: Install dependencies (renai)
        run: npm ci

      - name: Checkout note-auto-core
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: note-auto-core
          ref: main
          token: ${{ secrets.CORE_REPO_TOKEN }}

      - name: Install core and link locally
        run: |
          cd note-auto-core
          npm install
          cd ..
          npm install ./note-auto-core

      - name: Run script (schedule -> production)
        if: ${{ github.event_name == 'schedule' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          node scripts/twitterPostAmazonWishlistRanking.js

      - name: Run script (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dryrun }}" = "true" ]; then
            echo "Run in dryrun mode"
            node scripts/twitterPostAmazonWishlistRanking.js --dryrun
          else
            node scripts/twitterPostAmazonWishlistRanking.js
          fi
