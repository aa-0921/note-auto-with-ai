name: Twitter Post Sale Tweet

on:
  # schedule:
  #   # twitter-post-follower-growth.yml で減った分のスケジュール
  #   - cron: '0 22 * * *'                  # JST 07:00（UTC 22:00）
  #   - cron: '0 1,3,5,7,9,11 * * *'        # JST 10:00, 12:00, 14:00, 16:00, 18:00, 20:00（UTC 01:00, 03:00, 05:00, 07:00, 09:00, 11:00）
  workflow_dispatch:
    inputs:
      dryrun:
        description: 'Dryrun (true の場合は投稿しない)'
        required: false
        default: 'false'

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    concurrency:
      group: twitter-post-sale-tweet
      cancel-in-progress: false
    env:
      TZ: Asia/Tokyo

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Chrome dependencies for Puppeteer
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates \
            fonts-liberation \
            libasound2t64 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libgtk-3-0 \
            libgbm1 \
            libnss3 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libxshmfence1

      - name: Install dependencies (renai)
        run: npm ci

      - name: Checkout note-auto-core
        uses: actions/checkout@v4
        with:
          repository: aa-0921/note-auto-core
          path: note-auto-core
          ref: main
          token: ${{ secrets.CORE_REPO_TOKEN }}

      - name: Install core and link locally
        run: |
          cd note-auto-core
          npm install
          cd ..
          npm install ./note-auto-core

      - name: Run script (schedule -> production)
        if: ${{ github.event_name == 'schedule' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          node scripts/postSaleTweet.js

      - name: Run script (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.dryrun }}" = "true" ]; then
            echo "Run in dryrun mode"
            node scripts/postSaleTweet.js --dryrun
          else
            node scripts/postSaleTweet.js
          fi

