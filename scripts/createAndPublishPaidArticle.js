// createAndPublishPaidArticle.js
// 有料記事を作成して自動投稿するスクリプト

import { runWithCore } from '@aa-0921/note-auto-core';

// アフィリエイト設定とリンクを別ファイルから読み込み
import { affiliateConfig, affiliateLinks } from './affiliateConfig.js';

// 記事内容配列（A）を読み込み
import articleContents from './articleContents.js';

// 再エクスポート（他のファイルから参照できるように）
export { affiliateConfig, affiliateLinks };

(async () => {
  await runWithCore(async ({ core, wantsBackground }) => {
    // このスクリプトだけ異なるAIモデルを使用する
    core.aiGenerator.models.article = 'tngtech/deepseek-r1t2-chimera:free';
    core.aiGenerator.models.rewrite = 'tngtech/deepseek-r1t2-chimera:free';
    core.aiGenerator.models.tags = 'tngtech/deepseek-r1t2-chimera:free';
    console.log('使用するAIモデル:', core.aiGenerator.models);

    // アカウント固有の題材・切り口（ここで管理）
    // 「AI稼ぎ方.md」で扱っているテーマを中心に構成
    const topics = [
      'AIで記事の毎日投稿を自動化する方法',
      'AIで有料記事級のコンテンツを書く方法',
      'AI音楽で不労所得をつくる方法',
      'n8nとAIで自動アップセルする仕組み',
      'AIを使った副業の始め方',
      'AIでnoteの有料記事を量産する方法',
      'AIでnoteのコンテンツ作成時間を短縮する方法',
      'AIと自動化で継続収益をつくる考え方',
      'AIを相棒にして記事の質を上げる方法',
      'AIとワークフローで仕組み化する方法',
      'AIで不労所得の選択肢を広げる方法',
      'AIを使ってブログやnoteを自動化する方法',
      // noteで有料記事が売れそうなトピック（AI/不労所得/自動化/副業関連のみ）
      '副業で月10万円を稼ぐ具体的なステップ',
      'SNSでフォロワーを増やして収益化する方法',
      'Kindle出版で不労所得を作る完全ガイド',
      'YouTubeチャンネルを0から収益化する方法',
      'オンラインサロンを立ち上げて継続収益を作る方法',
      'スキルシェアで高単価案件を獲得する方法',
      'アフィリエイトで月5万円を安定して稼ぐコツ',
      'クラウドソーシングで単価を上げる交渉術',
      'AIとアフィリエイトを組み合わせた自動収益化',
      'AIでYouTube動画の自動生成と収益化',
      'AIを活用したKindle出版の自動化ワークフロー',
      'AIでSNS投稿を自動化して収益化する方法',
      'AIと自動化ツールで副業を仕組み化する方法',
      'AIで情報発信を自動化して不労所得を作る',
      'AIを活用したオンラインサロン運営の自動化',
      'AIでコンテンツ制作を自動化して複数収益源を作る',
      'AIとクラウドソーシングで高単価案件を獲得する戦略',
      'AIで副業をスケールさせて本業収入を超える方法',
    ];

    // 記事の切り口・構成のパターン
    // 「AI稼ぎ方.md」に書かれている構成パターンを反映
    const patterns = [
      '読者の悩みや課題から入る構成',
      'この方法で実現できることを最初に示す構成',
      '実績や成果を具体的な数字で見せる構成',
      'ステップバイステップで手順を解説する構成',
      '長期的な視点で収益化を考える構成',
      'AIの限界を認めつつ適切な使い方を提示する構成',
      '副業初心者にもわかりやすくかみ砕いて説明する構成',
      '自動化によって時間と手間を減らす価値を伝える構成',
      '不労所得の選択肢としてAIを位置づける構成',
      '具体的なツールやワークフローを紹介する構成',
      '読者の状況に寄り添って語りかける構成',
      '導入・本編・まとめの流れで整理して伝える構成',
      // noteで有料記事が売れそうなパターン
      '失敗談から学ぶ実体験ベースの構成',
      '成功事例を複数紹介して再現性を示す構成',
      'Before/Afterで変化を明確に示す構成',
      'チェックリスト形式で実践しやすくする構成',
      'Q&A形式で読者の疑問に答える構成',
      'ストーリーテリングで共感を生む構成',
      '比較・対比で選択肢を明確にする構成',
      '初心者と上級者で分けて説明する構成',
      'よくある間違いを指摘して正解を示す構成',
      '時系列で成長過程を追う構成',
      'データや統計を根拠に説得力を高める構成',
      '読者の感情に訴えかけるストーリー構成',
      '実践的なワークシートやテンプレートを提供する構成',
      '専門家の知見を引用して権威性を持たせる構成',
      '読者の目標達成までのロードマップを示す構成',
      'コストパフォーマンスを明確に示す構成',
      'リスクと対策をセットで提示する構成',
      '読者の不安を先回りして解消する構成',
      '短期的な成果と長期的な価値を両方示す構成',
      '読者がすぐに行動できる具体的なアクションを提示する構成',
    ];

    const rewriteConditionsLines = [
      'あなたはAIを活用した副業・自動化の専門家です。',
      '指定の見出し本文が短いため、200文字以上になるよう実体験や具体例、実践的なアドバイスを交えて厚くリライトしてください。',
      '読者は副業初心者〜中級者で、AIに興味はあるがまだうまく使いこなせていない人です。',
      '難しい専門用語はできるだけ避け、噛み砕いた説明で安心感を与えてください。',
      '【注意】',
      '- タイトルや見出しは出力せず、本文のみを返す。',
      '- メタ情報（追加要素や文字数など）は一切出力しない。',
      '- 丁寧な敬語（です・ます）で、読みやすさ重視。',
      '- 絵文字を多めに、各行に1つ程度。',
      '- 元の内容に沿い、noteのMarkdownのみ使用。',
      '- 箇条書きは「・ 」、番号付きリストは使わない。',
      '- 特殊トークンや制御文字（<|begin_of_sentence|>等）は絶対に出力しない。',
      '- 自然で読みやすい日本語のみを出力する。',
      '- 完成した文章のみを返し、システムメッセージや処理情報は含めない。',
      '- 日本語の文章の中に英単語を混ぜないでください。すべて日本語で表現してください。',
      '- 【重要】絵文字を使用する場合は句読点（。や、）は付けないでください。句読点と絵文字を同時に使うことは禁止です。絵文字を使う場合は句読点は不要です。',
    ];

    // LLM用システムプロンプト（AI稼ぎ方.mdのテイストに準拠）
    const systemMessage =
      'あなたはAIを活用した副業・自動化の専門家で、日本語のnote記事編集者です。「AI稼ぎ方.md」にあるような、有料記事として価値のある構成と濃さで記事を作成してください。' +
      '【最重要】記事は必ず「## 有料セクション」の見出しを含め、その後に5000文字程度の詳細な内容を最後まで完全に生成してください。途中で生成を止めてはいけません。';

    // 記事生成プロンプト条件（有料記事用の構造を含む）
    const articleConditionsLines = [
      '【最重要】記事は必ず以下の4つの見出しを含めて、最後まで完全に生成してください：',
      '1. ## はじめに',
      '2. ## 有料記事部分のご紹介',
      '3. ## 有料部分の内容について',
      '4. ## 有料セクション',
      '',
      '【最重要】「## 有料セクション」の見出しの後に、必ず5000文字程度の詳細な内容を書いてください。',
      '記事が途中で終わってはいけません。「## 有料セクション」の内容を最後まで完全に生成してください。',
      '',
      'タイトル、本文、ハッシュタグ（#から始まるもの）を含めてください。',
      'タイトルは1行目に「# [実際のタイトル]」として記載してください。',
      '「# タイトル」という文字列ではなく、実際の記事タイトルを入れてください。',
      'タイトルや本文には、できるだけ「AI」「自動化」「副業」「不労所得」などのキーワードを自然な形で盛り込んでください。',
      '本文にはタイトルを含めないでください。',
      '',
      '【記事の構造】以下の順序で必ず作成してください：',
      '',
      '## はじめに',
      '導入部分（無料で読める部分、500文字程度）',
      '   ・ 読者の興味を引く導入',
      '   ・ 記事の概要や背景',
      '   ・ 読者が共感できる悩みや不安',
      '',
      '## 有料記事部分のご紹介',
      '有料記事部分のメリット案内（200文字程度）',
      '   ・ 有料セクションで読める記事内容の価値やメリットのみを記載',
      '   ・ 記事の内容以外のサービス（スクリーンショット、ショートカット一覧、サポート体制など）は絶対に記載しない',
      '   ・ 記事コンテンツで得られる知識やノウハウのみを説明する',
      '',
      '## 有料部分の内容について',
      '有料部分でどんな記事内容が読めるのかを読者に伝えるセクションです。',
      '   ・ 箇条書き（「・ 」）で3〜7個程度、記事内のトピックを並べてください。',
      '   ・ 各項目は1〜2文で簡潔に、でも具体的に記述してください。',
      '   ・ 「誰向けか」「どんな変化・成果が期待できるか」も含めてください。',
      '   ・ ここはあくまで有料部分の"目次・要約"であり、本文そのものではありません。',
      '   ・ 【重要】記事の内容のみを記載し、記事以外のサービス（スクリーンショット、ショートカット一覧、サポート体制、質問し放題など）は絶対に記載しないでください。',
      '',
      '## 有料セクション',
      '【重要】このセクションは5000文字程度の詳細な内容を必ず書いてください。',
      '   ・ 具体的で実践的な内容',
      '   ・ 読者が求める深い情報やノウハウ',
      '   ・ 見出し（### サブ見出し）や箇条書きを交えて丁寧にまとめてください',
      '   ・ AIを丸投げではなく「相棒」や「編集者」として使う考え方を伝えてください',
      '   ・ ステップバイステップの手順や長期的な視点を含めてください',
      '   ・ 実体験や具体例を豊富に含めてください',
      '   ・ このセクションを最後まで完全に生成してください。途中で終わってはいけません。',
      '',
      '【最終確認】記事には必ず以下の4つの見出しが順番通りに含まれていることを確認してください：',
      '1. ## はじめに',
      '2. ## 有料記事部分のご紹介',
      '3. ## 有料部分の内容について',
      '4. ## 有料セクション（この後に5000文字程度の詳細な内容を必ず書く）',
      '',
      'ハッシュタグは記事末尾に「#〇〇 #〇〇 ...」の形式でまとめてください。',
      'あなたはAIを活用した副業・自動化の専門家で、プロの編集者です。',
      '読みやすさを重視してください。',
      '可能であればランキング形式やステップ形式を取り入れてください。',
      '改行を多めに入れてください。',
      '各行に1つ程度、絵文字を使用してください。',
      'すべて日本語で出力してください。',
      '切り口に沿った内容にしてください。',
      'noteの正しいマークダウン記法のみを使ってください。',
      '箇条書きはマークダウンではなく、「・ 」で表現してください。',
      '見出しはh2（## 見出し）・h3（### 見出し）のみ。',
      '見出しに「**」等は使わないでください。',
      '番号付きリストは使わないでください。',
      'h1（# タイトル）はタイトル行のみで本文中では使わないでください。',
      'その他のマークダウンやHTMLタグは使わないでください。',
      '【重要】特殊トークンや制御文字（<|begin_of_sentence|>、<｜begin▁of▁sentence｜>等）は絶対に出力しないでください。',
      '【重要】自然で読みやすい日本語のみを出力し、システムメッセージや処理情報は一切含めないでください。',
      '【重要】完成した記事のみを返してください。',
      '【重要】日本語の文章の中に英単語を混ぜないでください。すべて日本語で表現してください。',
      '【重要】絵文字を使用する場合は句読点（。や、）は付けないでください。句読点と絵文字を同時に使うことは禁止です。絵文字を使う場合は句読点は不要です。例：「誰でも始められる不労所得の選択肢が広がります🌐」のように、絵文字の前後に句読点を付けないでください。',
      '',
      '【禁止事項】記事の提供以外のサービスを保証するような内容は絶対に記載しないでください。',
      '   ・ スクリーンショットの提供',
      '   ・ ショートカット一覧の提供',
      '   ・ サポート体制や質問し放題のサービス',
      '   ・ 記事以外の特典や追加サービス',
      '   ・ 上記のような内容を暗示する表現も使用しないでください。',
      '',
      '【最終確認】記事には必ず「## 有料部分の内容について」と「## 有料セクション」という見出しが含まれていることを確認してください。',
      'これらの見出しが含まれていない記事は無効です。',
    ];

    // タグ生成の指示文（参考実装：固定タグの必須含有を要求）
    const tagsInstruction =
      '記事内容から最も関連する日本語タグを3〜5個生成し、半角スペース区切りで出力してください。必ず「#引き寄せ #引き寄せの法則 #裏技 #PR」を含めてください。本文や説明は禁止。';

    // タイトル装飾用絵文字（参考実装のセット）
    const titleEmojis = [
      '❤️',
      '🌸',
      '🛑',
      '㊙︎',
      '🟥',
      '🈲',
      '🉐',
      '㊗️',
      '㊙️',
      '⭕',
      '‼️',
      '🎉',
    ];

    // ----------------------------------------------------------------------------------

    // 有料記事設定（AI稼ぎ方.mdの価格帯に寄せる）
    const paidEnabled = true; // 有料記事にするか
    // 価格をランダムに選択（AI稼ぎ方.mdを参考にした価格帯）
    const priceOptions = [1980, 2980, 3980];
    const price = priceOptions[Math.floor(Math.random() * priceOptions.length)];
    console.log(`選択された価格: ${price}円`);

    // 記事内容配列（A）が存在するかチェック
    const articleContentsArray = Array.isArray(articleContents) && articleContents.length > 0
      ? articleContents
      : undefined;

    // 記事の自動生成と有料記事としての投稿機能を実行
    await core.runCreateAndPublishPaidArticle({
      background: wantsBackground,
      // 記事内容配列（A）が存在する場合はそれを渡す（存在しない場合は topics と patterns を使用）
      articleContents: articleContentsArray,
      topics,
      patterns,
      paidEnabled,
      price,
      systemMessage,
      articleConditionsLines,
      rewriteConditionsLines,
      tagsInstruction,
      titleEmojis,
      // 有料記事ではアフィリエイトリンク、おすすめ記事セクションは不要（core側で無効化）
      affiliateLinks: [],
      magazinePromotion: [],
      amazonAssociateText: '',
      // おすすめ記事セクション設定（有料記事では不要）
      recommendedArticlesTitle: '',
      recommendedArticlesUrls: [],
      // 有料記事用の設定
      maxTokens: 12000, // 長い記事を生成するため
      paidMode: true, // 有料記事モードを有効化
      paidRewriteHeading: '有料部分の内容について', // このセクションのみリライト
    });
    console.log('有料記事の自動生成と投稿が完了しました');
  });
})();

