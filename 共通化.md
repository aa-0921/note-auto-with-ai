## 目的

- 複数の note アカウント／ジャンルで同種の自動処理を運用するにあたり、共通部分を一元化し、各アカウント側は最小限の差分設定のみで維持・拡張できるようにする。
- 既存のローカル実行コマンド（例: `node likeUnlikedNotes.js --bg` 等）の挙動・引数・ログを変更せずに移行する。
- GitHub Actions の無料枠を活用しつつ、Docker を使わない前提でも運用可能とする。

## 全体方針（コード共通化 × 設定差分）

- 共有リポジトリ（public）を 1 つ用意し、そこに共通ロジック・テンプレート・デフォルト設定を集約する。
- 各アカウント側リポジトリでは、基本的に「設定ファイル＋薄い実行スクリプト（ラッパー）」のみを持ち、実装は共有ライブラリを利用する。
- アカウント差分（例: プロンプト、投稿時間帯、タグ、レート設定など）は設定ファイル（YAML/JSON）で表現し、優先度（デフォルト → ジャンル共通 → アカウント固有）で上書きする設定駆動にする。

## リポジトリ構成（最小）

- 共有リポ（private）: `note-auto-core`
  - 共通ライブラリ（npm 公開; Node/ESモジュール）
  - デフォルト設定（例: `configs/defaults/*.yaml`）
  - （任意）再利用可能 Workflow / Composite Action（Docker 不要）
- 各アカウント側リポ: `note-auto-<genre-or-account>`
  - アカウント固有設定（`config/account.yaml` や `config/prompts/*.yaml`）
  - 既存スクリプト名のままの薄いラッパー（内部で共有ライブラリを呼ぶ）

## 導入・インストール（Docker なし）

- 共有リポを npm に private 発行: `@aa-0921/note-auto-core`
- 各アカウント側でインストール:
  - `npm install @aa-0921/note-auto-core`
- 既存スクリプトはそのまま残し、中身で共有ライブラリを呼ぶようにする（ストラングラーパターン）。

## ローカル実行の維持

- 既存の実行例はそのまま利用可能:
  - `node likeUnlikedNotes.js --bg`
  - `node autoPublishNotes.js --bg`
  - `node follow/followFromArticles.js --bg`
  - `node likeNotesByUrl.js --bg https://note.com/...`
- 代替として、コア側に CLI を `bin` で提供し、`npx note-core <cmd>` も併用可能（任意; 既存コマンドは継続）。

## 設定駆動（差分表現）

- 設定例: `config/account.yaml`
  - `genre`, `locale`, `posting`（曜日・時間帯）, `ai`（モデル・温度・テンプレ）, `note`（認証方法）, `sheets`（連携有無） など。
- プロンプトはテンプレート化（Mustache/Jinja 風）し、`{{genre}}`, `{{seasonal_topic}}` 等の変数でアカウント差分を吸収。
- 優先度: 共通デフォルト → ジャンル共通 → アカウント固有。未指定はデフォルトを採用。

## バージョニング・更新

- 共有ライブラリは SemVer 準拠。
  - 破壊的変更はメジャー更新（例: v1 → v2）。
  - 各アカウント側は `^1.x` の範囲で追随。
- Renovate/Dependabot による自動アップデート PR（任意; 推奨）。

## GitHub Actions（推奨：Publicリポジトリ活用）

### 無料枠の活用

- **Publicリポジトリ**: GitHub Actions無制限で無料利用可能
- **Privateリポジトリ**: 月間2,000分まで無料（超過分は従量課金）
- **推奨**: 複数アカウント運用時はPublicリポジトリで無制限利用

### Publicリポジトリ構成のメリット

- **GitHub Actions無制限利用** - 定期実行の制限なし
- **複数アカウント不要** - 1つのGitHubアカウントで複数リポジトリ運用可能
- **共有ライブラリの公開** - `note-automation-core`をpublicで公開し、他のリポジトリから参照可能
- **Docker 不要で運用可能** - `actions/setup-node` + `npm ci` + 共有ライブラリ呼び出し

### 注意点

- **コードが公開される** - ソースコードが一般に公開される
- **Secretsの管理** - APIキーやCookie等はSecretsで管理（公開されない）
- **機密情報の除外** - `.env`ファイルや機密データは`.gitignore`で除外

### 推奨構成（混在版：第一候補）

```
GitHubアカウント: aa-0921

Privateリポジトリ:
├── note-auto-core (private)    # 共通ライブラリ・設定
    ├── 共通ロジック
    ├── デフォルト設定
    └── 再利用可能Workflow

Publicリポジトリ:
├── note-auto-renai (public)     # 恋愛・人間関係アカウント
├── note-auto-tech (public)      # 技術系アカウント
├── note-auto-health (public)    # 健康系アカウント
└── note-auto-business (public)   # ビジネス系アカウント
```

### 混在構成のメリット

- **GitHub Actions実行履歴の分離**: 各noteアカウントの実行履歴が独立して管理される
- **無制限実行**: PublicリポジトリなのでGitHub Actions無制限で無料
- **セキュリティの最適化**: 共通ライブラリはPrivateで保護、各アカウント設定はPublic
- **運用の柔軟性**: 各アカウントリポジトリを独立して更新・デプロイ可能

### 実行の流れ

1. **Privateリポジトリ（note-auto-core）**
   - GitHub Actions実行: パッケージ公開時のみ
   - 実行時間: 月間2,000分で十分（パッケージ公開のみ）

2. **Publicリポジトリ（各アカウント）**
   - GitHub Actions実行: 定期実行・手動実行
   - 実行時間: **無制限で無料**（Publicリポジトリのため）
   - 実際のnote投稿・いいね・フォロー等の処理を実行

### 実装例

```yaml
# note-auto-renai (public) の .github/workflows/schedule.yml # TODO: リポジトリ用にリポジトリ名を変更してください
name: Daily Tasks
on:
  schedule:
    - cron: '0 9 * * 1-5' # 平日9時
jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm install @aa-0921/note-auto-core # Privateリポから公開されたパッケージ
      - run: node likeUnlikedNotes.js --bg # 実際の処理実行
        env:
          NOTE_COOKIE: ${{ secrets.NOTE_COOKIE }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
```

### 定期実行頻度の調整

- **設定ファイルでの頻度制御**: `config/schedule.yaml`で各スクリプトの実行頻度を個別設定
- **アカウント別の実行パターン**:
  - 毎日実行（`daily`）
  - 平日のみ（`weekdays`）
  - 週1回（`weekly`）
  - 月1回（`monthly`）
  - カスタムcron式（`custom`）
- **負荷分散**: 各アカウントで実行時刻を分単位でずらし、API制限を回避
- **実行時間帯の制御**: 営業時間内のみ実行、深夜時間帯の実行など

### 設定例

```yaml
# config/schedule.yaml
scripts:
  likeUnlikedNotes:
    frequency: daily
    time_offset: 0 # 0分オフセット
  autoPublishNotes:
    frequency: weekdays
    time_offset: 5 # 5分オフセット
  followFromArticles:
    frequency: weekly
    time_offset: 10
  likeNotesByUrl:
    frequency: daily
    time_offset: 15
    urls:
      - 'https://note.com/counselor_risa' # TODO: リポジトリ用にnoteアカウント名を変更してください
      - 'https://note.com/investment_happy'
      - 'https://note.com/enginner_skill'
```

### OpenRouter API制限の回避

- **複数アカウントの活用**: OpenRouterのAPI制限はアカウント単位で適用されるため、複数アカウントを作成することで制限を分散可能
- **RPS（Requests Per Second）の向上**: アカウント残高に応じてRPSが増加（1ドル未満でも最小1RPS、500ドル以上で最大500RPS）
- **アカウント別のAPIキー管理**: 各noteアカウント用リポジトリで異なるOpenRouter APIキーを使用
- **負荷分散**: 各アカウントで異なるAPIキーを使用し、同時実行時の制限を回避
- **設定例**:
  ```yaml
  # config/account.yaml
  ai:
    provider: openrouter
    api_key_secret_name: OPENROUTER_API_KEY_ACCOUNT_1
    model: gpt-4o-mini
    temperature: 0.7
  ```

## 前準備（共通化前の整理）

### 1. 不要なものの削除 ✅完了

- 使用されていないファイル・ディレクトリの特定と削除
- 不要な依存関係（`package.json`の`dependencies`）の削除
- 古い設定ファイルやテストファイルの整理
- 重複する機能の統合
- **実行済み**: 重複ファイル（`posts/70__2025-06-16-引き寄せの法則の真実：ありがちな勘違いと正しいやり方.md`）を削除

### 2. CommonJS → ESモジュール対応 ✅完了

- `package.json`に`"type": "module"`を設定（ESモジュール化完了）
- `require()` → `import`文への変換完了
- `module.exports` → `export`文への変換完了
- `__dirname`, `__filename`の代替手段実装完了（`import.meta.url`使用）
- 動的`require()`の対応完了（`import()`使用）
- **実行済み**: 全ファイルのESモジュール化が完了し、動作確認済み

### 3. 動作確認 ✅完了

- 各スクリプトの個別実行テスト
- 既存の実行コマンドでの動作確認
- エラーハンドリングの確認
- ログ出力の確認
- **実行済み**: `node autoCreateAndDraftNote.js --bg`で動作確認

### 4. タイトル生成の問題修正 ✅完了

- **問題**: AIが「㊗️ タイトル」のような不適切なタイトルを生成
- **原因**: 絵文字リストに`'㊗️'`が含まれている + プロンプトで「# タイトル」と指示
- **解決策**:
  - 絵文字リストから`'㊗️'`を削除
  - プロンプトを「# [実際のタイトル]」に変更
  - 追加指示「「# タイトル」という文字列ではなく、実際の記事タイトルを入れてください」を追加

## 段階移行のガイド（処理を一切変えずに共通化）

### 現在の進捗状況

1. ✅ **現行コードの整理** - 不要ファイル削除、ESモジュール対応、動作確認完了
2. ✅ **リポジトリコピー** - 現在のリポジトリを`note-auto-renai`にコピー完了 # TODO: リポジトリ用にリポジトリ名を変更してください
3. ✅ **Private共通リポジトリ作成** - note-auto-core基盤作成完了
4. ✅ **共通ロジックの抽出とライブラリ化** - 完了
5. ✅ **npmパッケージの公開設定** - 完了
6. ✅ **追加の共通化機能実装** - 完了
7. ⏳ **各アカウント用Publicリポジトリの作成** - 次のステップ
8. ⏳ **既存コードの移行とテスト** - 予定

### 具体的な手順

1. ✅ 現行スクリプトの入出力と引数仕様を一覧化（ドキュメント化）。
2. ✅ 共有ライブラリ側に、現行仕様と互換の API を用意。
3. ✅ 各スクリプトの内部実装のみを共有ライブラリ呼び出しに差し替え（関数名・引数・戻り値・ログは不変）。

### 追加で共通化した機能（v1.0.5）

- **アフィリエイトリンク挿入機能**: 記事の最初、中間、最後にアフィリエイトリンクを自動挿入
- **マガジン誘導セクション**: 物理的に幸せになるおすすめグッズ達のマガジン誘導
- **記事の加工・統合機能**: リライト、アフィリエイトリンク、マガジン誘導、タグ付与を統合
- **タイトル絵文字追加機能**: タイトルにランダム絵文字を自動追加
- **autoCreateAndDraftNote.js**: 記事の自動生成と下書き保存機能を薄いラッパーに変換

4. アカウント固有の値を `config/account.yaml` 等へ切り出し（既存の直書きがあれば読み替え）。
5. 最初は 1 スクリプトだけ移行 → 動作確認 → 残りを順次移行。

### ローカルディレクトリ構造（実装済み）

```
/Users/aa/projects/note-automation/
├── note-auto-core/          # 共通ライブラリ（Private）- ✅完了
├── note-auto-renai/         # 恋愛・人間関係アカウント（Public）- ✅完了
├── note-auto-tech/          # 技術系アカウント（Public）- 未作成
├── note-auto-health/        # 健康系アカウント（Public）- 未作成
└── note-auto-business/      # ビジネス系アカウント（Public）- 未作成
```

### リポジトリコピーの実行結果

- **元のリポジトリ**: `/Users/aa/projects/note-renai-ningenkankei`（定期実行継続中）
- **新しいリポジトリ**: `/Users/aa/projects/note-automation/note-auto-renai`
- **GitHubリポジトリ**: `https://github.com/aa-0921/note-auto-renai.git`
- **コピー方法**: Gitクローン（最も効率的）
- **状態**: すべてのファイルが正常にコピーされ、リモートリポジトリに接続済み

## 新規アカウントリポジトリ作成時の作業

- サムネイル画像の追加
- scripts配下ファイルの固有プロンプト等の変更
- ローカル・github側環境変数の追加

## 将来拡張

- CLI（`bin`）での一括起動・個別起動の両立。
- 再利用 Workflow / Composite Action 化（必要になった時点で導入）。
- ログ収集・失敗時のリトライ／指数バックオフを共有ライブラリで統一。

## 付録：最小コード例（薄いラッパー化のイメージ）

```javascript
// likeNotesByUrl.js
// 日本語コメント: 既存のCLI引数・動作は維持しつつ、実装は共有ライブラリに委譲します。
#!/usr/bin/env node
import { runLikeNotesByUrl } from '@aa-0921/note-auto-core';
const url = process.argv[process.argv.length - 1];
const bg = process.argv.includes('--bg');
runLikeNotesByUrl({ url, background: bg, accountConfigPath: 'config/account.yaml' })
  .catch(e => { console.error(e); process.exit(1); });
```

```yaml
# config/account.yaml（例）
genre: tech
locale: ja-JP
posting:
  time_window: ['09:00', '11:00']
  days: [Mon, Tue, Wed, Thu, Fri]
ai:
  model: gpt-4o-mini
  temperature: 0.7
  prompt_template: prompts/daily.yaml
note:
  login_method: cookie
  cookie_secret_name: NOTE_COOKIE
sheets:
  enabled: true
  doc_id: 'xxxxx'
  worksheet: 'posts'
overrides:
  seasonal_topic: '生成AI最新動向'
```
